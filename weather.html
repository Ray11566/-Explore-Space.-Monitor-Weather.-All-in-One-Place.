<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>India Weather Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="style2.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        .header {
            background: #1e88e5;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
        }

        select, button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }

        .container {
            display: flex;
            height: calc(100% - 65px);
        }

        .map-container {
            flex: 2;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .sidebar {
            flex: 1;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }

        .weather-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .weather-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .city-name {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .weather-icon {
            width: 60px;
            height: 60px;
        }

        .temp-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .detail-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
        }

        .detail-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #34495e;
        }

        .layer-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .layer-btn {
            display: block;
            width: 120px;
            padding: 8px;
            margin: 5px 0;
            background: #f0f2f5;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .layer-btn.active {
            background: #1e88e5;
            color: white;
        }

        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background: #ff4444;
            color: white;
            border-radius: 5px;
            animation: slideIn 0.3s ease-out;
        }

        .weather-alert {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            background: rgba(41, 128, 185, 0.9);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            max-width: 300px;
            animation: alertSlideIn 0.4s ease-out;
            backdrop-filter: blur(4px);
            border-left: 5px solid #2c3e50;
        }

        .sunny-alert {
            background: rgba(243, 156, 18, 0.9);
            border-left: 5px solid #d35400;
        }

        .wind-alert {
            background: rgba(192, 57, 43, 0.9);
            border-left: 5px solid #922b21;
        }
        
        @keyframes alertSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .map-container {
                height: 60vh;
            }
            .sidebar {
                height: 40vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">India Weather Map</div>
        <div class="controls">
            <select id="city-select">
                <option value="">Select City</option>
                <option value="Delhi">Delhi</option>
                <option value="Mumbai">Mumbai</option>
                <option value="Bangalore">Bangalore</option>
                <option value="Hyderabad">Hyderabad</option>
                <option value="Chennai">Chennai</option>
                <option value="Kolkata">Kolkata</option>
                <option value="Ahmedabad">Ahmedabad</option>
                <option value="Pune">Pune</option>
                <option value="Jaipur">Jaipur</option>
                <option value="Lucknow">Lucknow</option>
                <option value="Kanpur">Kanpur</option>
                <option value="Nagpur">Nagpur</option>
                <option value="Indore">Indore</option>
                <option value="Thane">Thane</option>
                <option value="Bhopal">Bhopal</option>
                <option value="Visakhapatnam">Visakhapatnam</option>
                <option value="Patna">Patna</option>
                <option value="Vadodara">Vadodara</option>
                <option value="Ghaziabad">Ghaziabad</option>
                <option value="Ludhiana">Ludhiana</option>
                <option value="Agra">Agra</option>
                <option value="Nashik">Nashik</option>
                <option value="Faridabad">Faridabad</option>
                <option value="Meerut">Meerut</option>
                <option value="Rajkot">Rajkot</option>
                <option value="Kalyan">Kalyan</option>
                <option value="Varanasi">Varanasi</option>
                <option value="Srinagar">Srinagar</option>
                <option value="Aurangabad">Aurangabad</option>
                <option value="Dhanbad">Dhanbad</option>
                <option value="Amritsar">Amritsar</option>
                <option value="Navi Mumbai">Navi Mumbai</option>
                <option value="Allahabad">Allahabad</option>
                <option value="Ranchi">Ranchi</option>
                <option value="Howrah">Howrah</option>
                <option value="Coimbatore">Coimbatore</option>
                <option value="Jabalpur">Jabalpur</option>
                <option value="Gwalior">Gwalior</option>
                <option value="Vijayawada">Vijayawada</option>
                <option value="Jodhpur">Jodhpur</option>
                <option value="Madurai">Madurai</option>
                <option value="Raipur">Raipur</option>
                <option value="Kota">Kota</option>
                <option value="Chandigarh">Chandigarh</option>
                <option value="Guwahati">Guwahati</option>
                <option value="Thiruvananthapuram">Thiruvananthapuram</option>
                <option value="Solapur">Solapur</option>
                <option value="Hubli">Hubli</option>
                <option value="Mysore">Mysore</option>
                <option value="Tiruchirappalli">Tiruchirappalli</option>
                <option value="Bareilly">Bareilly</option>
                <option value="Moradabad">Moradabad</option>
                <option value="Dehradun">Dehradun</option>
                <option value="Haridwar">Haridwar</option>
                <option value="Kochi">Kochi</option>
                <option value="Udaipur">Udaipur</option>
                <option value="Shimla">Shimla</option>
                <option value="Panaji">Panaji</option>
                <option value="Imphal">Imphal</option>
            </select>
            <button id="get-weather-btn">Get Weather</button>
            <button id="locate-btn">üìç Locate Me</button>
        </div>
    </div>

    <div class="container">
        <div class="map-container">
            <div id="map"></div>
            <div class="layer-controls">
                <button class="layer-btn active" data-layer="temp">Temperature</button>
                <button class="layer-btn" data-layer="clouds">Clouds</button>
                <button class="layer-btn" data-layer="precipitation">Precipitation</button>
                <button class="layer-btn" data-layer="wind">Wind</button>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="weather-card">
                <div class="weather-header">
                    <div class="city-name">Select a City</div>
                    <img class="weather-icon" id="weather-icon" src="/placeholder.svg" alt="Weather Icon">
                </div>
                <div class="temp-value" id="temp-value">- ¬∞C</div>
                <div class="weather-details">
                    <div class="detail-item">
                        <div class="detail-label">Weather</div>
                        <div class="detail-value" id="weather">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Description</div>
                        <div class="detail-value" id="description">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Feels Like</div>
                        <div class="detail-value" id="feels-like">- ¬∞C</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Humidity</div>
                        <div class="detail-value" id="humidity">- %</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Wind Speed</div>
                        <div class="detail-value" id="wind-speed">- m/s</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Pressure</div>
                        <div class="detail-value" id="pressure">- hPa</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Visibility</div>
                        <div class="detail-value" id="visibility">- km</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Sunrise</div>
                        <div class="detail-value" id="sunrise">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Sunset</div>
                        <div class="detail-value" id="sunset">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Use proxy server instead of direct API key
            // Change this URL to your deployed proxy server
            const PROXY_SERVER_URL = 'http://localhost:3000/api/weather'; // Local development
            // const PROXY_SERVER_URL = 'https://your-proxy-server.vercel.app/api/weather'; // Deployed
            
            // Initialize map
            const map = L.map('map').setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // Weather layers configuration - Note: These layers won't work without API key
            // You'll need to create separate proxy endpoints for these
            const weatherLayers = {
                temp: null,
                clouds: null,
                precipitation: null,
                wind: null
            };

            // Cities coordinates
            const cities = {
                'Delhi': { lat: 28.6139, lon: 77.2090 },
                'Mumbai': { lat: 19.0760, lon: 72.8777 },
                'Bangalore': { lat: 12.9716, lon: 77.5946 },
                'Hyderabad': { lat: 17.3850, lon: 78.4867 },
                'Chennai': { lat: 13.0827, lon: 80.2707 },
                'Kolkata': { lat: 22.5726, lon: 88.3639 },
                'Ahmedabad': { lat: 23.0225, lon: 72.5714 },
                'Pune': { lat: 18.5204, lon: 73.8567 },
                'Jaipur': { lat: 26.9124, lon: 75.7873 },
                'Lucknow': { lat: 26.8467, lon: 80.9462 },
                'Kanpur': { lat: 26.4499, lon: 80.3319 },
                'Nagpur': { lat: 21.1458, lon: 79.0882 },
                'Indore': { lat: 22.7196, lon: 75.8577 },
                'Thane': { lat: 19.2183, lon: 72.9781 },
                'Bhopal': { lat: 23.2599, lon: 77.4126 },
                'Visakhapatnam': { lat: 17.6868, lon: 83.2185 },
                'Patna': { lat: 25.5941, lon: 85.1376 },
                'Vadodara': { lat: 22.3072, lon: 73.1812 },
                'Ghaziabad': { lat: 28.6692, lon: 77.4538 },
                'Ludhiana': { lat: 30.9010, lon: 75.8573 },
                'Agra': { lat: 27.1767, lon: 78.0081 },
                'Nashik': { lat: 19.9975, lon: 73.7898 },
                'Faridabad': { lat: 28.4089, lon: 77.3178 },
                'Meerut': { lat: 28.9845, lon: 77.7064 },
                'Rajkot': { lat: 22.3039, lon: 70.8022 },
                'Kalyan': { lat: 19.2403, lon: 73.1305 },
                'Varanasi': { lat: 25.3176, lon: 82.9739 },
                'Srinagar': { lat: 34.0837, lon: 74.7973 },
                'Aurangabad': { lat: 19.8762, lon: 75.3433 },
                'Dhanbad': { lat: 23.7957, lon: 86.4304 },
                'Amritsar': { lat: 31.6340, lon: 74.8723 },
                'Navi Mumbai': { lat: 19.0330, lon: 73.0297 },
                'Allahabad': { lat: 25.4358, lon: 81.8463 },
                'Ranchi': { lat: 23.3441, lon: 85.3096 },
                'Howrah': { lat: 22.5958, lon: 88.2636 },
                'Coimbatore': { lat: 11.0168, lon: 76.9558 },
                'Jabalpur': { lat: 23.1815, lon: 79.9864 },
                'Gwalior': { lat: 26.2183, lon: 78.1828 },
                'Vijayawada': { lat: 16.5062, lon: 80.6480 },
                'Jodhpur': { lat: 26.2389, lon: 73.0243 },
                'Madurai': { lat: 9.9252, lon: 78.1198 },
                'Raipur': { lat: 21.2514, lon: 81.6296 },
                'Kota': { lat: 25.2138, lon: 75.8648 },
                'Chandigarh': { lat: 30.7333, lon: 76.7794 },
                'Guwahati': { lat: 26.1445, lon: 91.7362 },
                'Thiruvananthapuram': { lat: 8.5241, lon: 76.9366 },
                'Solapur': { lat: 17.6599, lon: 75.9064 },
                'Hubli': { lat: 15.3647, lon: 75.1240 },
                'Mysore': { lat: 12.2958, lon: 76.6394 },
                'Tiruchirappalli': { lat: 10.7905, lon: 78.7047 },
                'Bareilly': { lat: 28.3670, lon: 79.4304 },
                'Moradabad': { lat: 28.8386, lon: 78.7733 },
                'Dehradun': { lat: 30.3165, lon: 78.0322 },
                'Haridwar': { lat: 29.9457, lon: 78.1642 },
                'Kochi': { lat: 9.9312, lon: 76.2673 },
                'Udaipur': { lat: 24.5854, lon: 73.7125 },
                'Shimla': { lat: 31.1048, lon: 77.1734 },
                'Panaji': { lat: 15.4909, lon: 73.8278 },
                'Imphal': { lat: 24.8170, lon: 93.9368 }
            };

            // Add city markers
            Object.entries(cities).forEach(([city, coords]) => {
                L.marker([coords.lat, coords.lon])
                    .addTo(map)
                    .bindPopup(city)
                    .on('click', () => updateWeather(city, coords.lat, coords.lon));
            });

            // Layer controls - disabled for now as they require API key
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show message that layers require proxy server
                    showAlert('Weather layers require proxy server setup. See documentation.');
                });
            });

            // City select handler
            document.getElementById('city-select').addEventListener('change', function() {
                const city = this.value;
                if (city && cities[city]) {
                    map.flyTo([cities[city].lat, cities[city].lon], 10);
                    updateWeather(city, cities[city].lat, cities[city].lon);
                }
            });

            // Get weather button handler
            document.getElementById('get-weather-btn').addEventListener('click', function() {
                const city = document.getElementById('city-select').value;
                if (city && cities[city]) {
                    map.flyTo([cities[city].lat, cities[city].lon], 10);
                    updateWeather(city, cities[city].lat, cities[city].lon);
                } else {
                    alert("Please select a city.");
                }
            });

            // Location handler
            document.getElementById('locate-btn').addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        map.flyTo([lat, lon], 10);
                        
                        // Use proxy server for reverse geocoding
                        fetch(`${PROXY_SERVER_URL}?lat=${lat}&lon=${lon}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    updateWeatherByCoords(lat, lon);
                                } else {
                                    showError("Failed to get location name");
                                }
                            })
                            .catch(() => {
                                updateWeatherByCoords(lat, lon);
                            });
                    }, showError);
                } else {
                    showError("Geolocation not supported");
                }
            });

            // Weather update function using proxy server
            async function updateWeather(city, lat, lon) {
                try {
                    const params = new URLSearchParams();
                    if (city) params.append('city', city);
                    if (lat && lon) {
                        params.append('lat', lat);
                        params.append('lon', lon);
                    }

                    const response = await fetch(`${PROXY_SERVER_URL}?${params}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        const data = result.data;
                        updateWeatherUI(city, data);
                    } else {
                        showError(result.error || 'Failed to fetch weather data');
                    }

                } catch (error) {
                    console.error('Weather fetch error:', error);
                    
                    // Fallback: Try direct API (not recommended for production)
                    // showError('Proxy server not available. Please setup proxy server.');
                    
                    // For demo purposes only - remove this in production
                    showError('Weather service temporarily unavailable. Please setup proxy server.');
                }
            }

            // Update weather using coordinates only
            async function updateWeatherByCoords(lat, lon) {
                try {
                    const response = await fetch(`${PROXY_SERVER_URL}?lat=${lat}&lon=${lon}`);
                    const result = await response.json();

                    if (result.success) {
                        const data = result.data;
                        updateWeatherUI(data.name, data);
                    } else {
                        showError(result.error || 'Failed to fetch weather data');
                    }
                } catch (error) {
                    showError('Network error. Please try again.');
                }
            }

            // Update UI with weather data
            function updateWeatherUI(city, data) {
                document.querySelector('.city-name').textContent = city;
                document.getElementById('weather').textContent = data.weather[0].main;
                document.getElementById('description').textContent = data.weather[0].description;
                document.getElementById('temp-value').textContent = `${Math.round(data.main.temp - 273.15)} ¬∞C`;
                document.getElementById('feels-like').textContent = `${Math.round(data.main.feels_like - 273.15)} ¬∞C`;
                document.getElementById('humidity').textContent = `${data.main.humidity} %`;
                document.getElementById('pressure').textContent = `${data.main.pressure} hPa`;
                document.getElementById('wind-speed').textContent = `${data.wind.speed} m/s`;
                document.getElementById('visibility').textContent = `${(data.visibility / 1000).toFixed(1)} km`;
                document.getElementById('weather-icon').src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;

                const sunrise = new Date(data.sys.sunrise * 1000);
                const sunset = new Date(data.sys.sunset * 1000);
                document.getElementById('sunrise').textContent = sunrise.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.getElementById('sunset').textContent = sunset.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                showUmbrellaAlert(city, data.weather[0].main);
            }

            // Error handling
            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }

            // Show informational alert
            function showAlert(message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'weather-alert';
                alertDiv.innerHTML = message;
                document.body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 3000);
            }

            // Function to show weather alerts based on conditions
            function showUmbrellaAlert(city, condition) {
                let alertMessage = '';
                let alertClass = 'weather-alert';
                
                // Check for different weather conditions
                if (
                    condition.toLowerCase().includes("cloud") ||
                    condition.toLowerCase().includes("rain") ||
                    condition.toLowerCase().includes("drizzle") ||
                    condition.toLowerCase().includes("thunderstorm")
                ) {
                    alertMessage = `<strong>${city}:</strong> ${condition} conditions detected. Don't forget to take an umbrella with you! ‚òî`;
                    alertClass = 'weather-alert';
                } 
                else if (
                    condition.toLowerCase().includes("sunny") ||
                    condition.toLowerCase().includes("clear") ||
                    condition.toLowerCase().includes("hot")
                ) {
                    alertMessage = `<strong>${city}:</strong> ${condition} conditions detected. Remember to take a water bottle with you! üç∂`;
                    alertClass = 'weather-alert sunny-alert';
                }
                else if (
                    condition.toLowerCase().includes("wind") ||
                    condition.toLowerCase().includes("storm") ||
                    condition.toLowerCase().includes("tornado")
                ) {
                    alertMessage = `<strong>${city}:</strong> ${condition} conditions detected. It's very windy, consider staying at home! üè†`;
                    alertClass = 'weather-alert wind-alert';
                }
                
                // If we have an alert message, show it
                if (alertMessage) {
                    // Create alert element
                    const alertDiv = document.createElement('div');
                    alertDiv.className = alertClass;
                    alertDiv.innerHTML = alertMessage;
                    
                    // Add to document
                    document.body.appendChild(alertDiv);
                    
                    // Remove after 8 seconds
                    setTimeout(() => alertDiv.remove(), 8000);
                }
            }

            // Initial load - fetch Delhi weather immediately
            updateWeather('Delhi', cities['Delhi'].lat, cities['Delhi'].lon);
        });
    </script>
</body>
</html>